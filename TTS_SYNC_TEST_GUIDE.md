# 🧪 中文字幕同步優化測試指南

## 🎯 測試目標

驗證四大優化是否正常運作：
1. ✅ 精細標點權重（句號 0.9、問號 0.8、驚嘆號 0.7）
2. ✅ 動態 alpha 值（根據語速自適應）
3. ✅ 標點停頓檢測（接近標點時減速）
4. ✅ 靜音區域檢測（跳過開頭和結尾靜音）

---

## 📋 測試清單

### **測試 1：快速短句**

**操作步驟：**
1. 切換到中文模式
2. 問安安老師：「太棒了！」
3. 觀察播放過程

**預期結果：**
```
Debug 輸出：
[TTS] duration=1.20s, textLen=4
[TTS][ZH] speedPerChar=0.080s, alpha=0.15  ← 快速語音，alpha 較小
[TTS][Silence] duration=1.20s, leading=0.15s, trailing=0.10s
```

**檢查項目：**
- [ ] alpha = 0.15（快速語音）
- [ ] 字幕立即開始（無開頭延遲）
- [ ] 驚嘆號處快速帶過（權重 0.7）
- [ ] 字幕在語音結束時精準停止

---

### **測試 2：中速長句**

**操作步驟：**
1. 問：「什麼是大象？」
2. 觀察安安老師的回答

**預期回答範例：**
```
「大象是一種很大的動物。牠們住在非洲和亞洲，喜歡吃草和樹葉。」
```

**預期 Debug 輸出：**
```
[TTS] duration=5.50s, textLen=28
[TTS][ZH] speedPerChar=0.196s, alpha=0.25  ← 中速語音，預設 alpha
[TTS][Silence] duration=5.50s, leading=0.25s, trailing=0.20s
```

**檢查項目：**
- [ ] alpha = 0.25（中速語音）
- [ ] 問號處明顯停頓（權重 0.8）
- [ ] 句號處停頓更長（權重 0.9）
- [ ] 逗號處輕微停頓（權重 0.25）
- [ ] 字幕平滑推進，無跳躍

---

### **測試 3：慢速講故事**

**操作步驟：**
1. 問：「請講一個關於小狐狸的故事」
2. 觀察長篇回答

**預期回答範例：**
```
「從前從前，在一個遙遠的森林裡，住著一隻聰明的小狐狸。
牠每天都在森林裡探險，尋找新的朋友和有趣的事物。
有一天，牠遇到了一隻迷路的小兔子。
小狐狸決定幫助小兔子找到回家的路。」
```

**預期 Debug 輸出：**
```
[TTS] duration=12.80s, textLen=60
[TTS][ZH] speedPerChar=0.213s, alpha=0.35  ← 慢速語音，alpha 較大
[TTS][Silence] duration=12.80s, leading=0.35s, trailing=0.30s
```

**檢查項目：**
- [ ] alpha = 0.35（慢速語音，更平滑）
- [ ] 每個句號處都有明顯停頓
- [ ] 逗號處停頓短於句號
- [ ] 字幕在標點前後減速
- [ ] 整體推進非常平滑

---

### **測試 4：混合標點**

**操作步驟：**
1. 問：「哇！真的嗎？太不可思議了。」
2. 觀察不同標點的效果

**預期 Debug 輸出：**
```
[TTS][ZH] t=0.5/2.50 idx=1/12  ← 驚嘆號，快速通過
[TTS][ZH] t=1.2/2.50 idx=5/12  ← 問號，中等停頓
[TTS][ZH] t=2.3/2.50 idx=11/12 ← 句號，較長停頓
```

**檢查項目：**
- [ ] 驚嘆號（！）停頓最短
- [ ] 問號（？）停頓中等
- [ ] 句號（。）停頓最長
- [ ] 三種標點明顯區分

---

## 🔍 進階檢查

### **檢查動態 Alpha**

在 Xcode Console 中搜尋：
```
[TTS][ZH] speedPerChar=
```

**驗證規則：**
- speedPerChar < 0.1s → alpha = 0.15
- 0.1s ≤ speedPerChar ≤ 0.2s → alpha = 0.25
- speedPerChar > 0.2s → alpha = 0.35

---

### **檢查靜音檢測**

在 Console 中搜尋：
```
[TTS][Silence] duration=
```

**驗證規則：**
- duration < 2s → leading=0.15s, trailing=0.10s
- 2s ≤ duration < 5s → leading=0.25s, trailing=0.20s
- duration ≥ 5s → leading=0.35s, trailing=0.30s

---

### **檢查標點感知**

觀察字幕推進速度：
1. 接近標點時：推進速度明顯減慢
2. 離開標點後：恢復正常速度
3. 標點符號處：字幕停留時間較長

---

## 🎬 視覺測試

### **順暢度測試**

錄製播放過程，檢查：
- [ ] 無突兀跳躍
- [ ] 無回退現象
- [ ] 高亮平滑移動
- [ ] 標點處自然停頓

### **同步精度測試**

使用秒錶對比：
1. 記錄語音開始時間
2. 記錄字幕開始時間
3. **誤差應 < 0.1 秒**

---

## 📊 性能測試

### **CPU 使用率**

在 Xcode Instruments 中檢查：
- [ ] Timer 運行時 CPU < 5%
- [ ] 無記憶體洩漏
- [ ] 無卡頓掉幀

### **記憶體使用**

檢查播放前後記憶體：
- [ ] 增量 < 5MB
- [ ] 播放結束後正確釋放

---

## ⚠️ 已知問題排查

### **問題 1：字幕完全不動**

**可能原因：**
- 權重總和為 0
- cumulative 陣列為空

**Debug 方法：**
```
檢查 Console：
[TTS][ZH] cumulative total is 0
```

**解決方法：**
- 檢查文字是否包含有效字符
- 檢查 `makeChineseWeights` 邏輯

---

### **問題 2：字幕太快或太慢**

**可能原因：**
- alpha 值計算錯誤
- 靜音檢測不準確

**Debug 方法：**
```
檢查 Console：
[TTS][ZH] speedPerChar=XXX, alpha=XXX
```

**調整建議：**
```swift
// 微調 alpha 閾值
if speedPerChar < 0.12 {  // 原本 0.1
    dynamicAlpha = 0.18   // 原本 0.15
}
```

---

### **問題 3：標點停頓不明顯**

**可能原因：**
- `isNearPunctuation` 未正確觸發
- punctuationFactor 設定不夠

**Debug 方法：**
```swift
// 在 Timer 中加入 print
if nearPunctuation {
    print("[TTS][Punct] Near punctuation at index \(currentCharIndex)")
}
```

**調整建議：**
```swift
// 增強停頓效果
let punctuationFactor = nearPunctuation ? 0.3 : 1.0  // 原本 0.5
```

---

## 📈 基準測試

### **測試句子庫**

```swift
let testCases = [
    // 短句
    "太好了！",
    "是嗎？",
    "沒問題。",
    
    // 中句
    "大象是一種很大的動物。",
    "你知道什麼是重力嗎？",
    "哇！這真是太神奇了！",
    
    // 長句
    "從前從前，在一個遙遠的森林裡，住著一隻聰明的小狐狸。",
    
    // 混合標點
    "什麼？真的嗎！太不可思議了。",
    "嗨，你好！今天天氣真好，對吧？"
]
```

---

## ✅ 最終檢查清單

### **功能完整性**
- [ ] 所有標點權重正確設定
- [ ] 動態 alpha 正確計算
- [ ] 標點停頓正確檢測
- [ ] 靜音區域正確跳過

### **用戶體驗**
- [ ] 字幕與語音完美同步
- [ ] 標點處停頓自然
- [ ] 無突兀跳躍或卡頓
- [ ] 適應不同語速

### **性能表現**
- [ ] CPU 使用率正常
- [ ] 記憶體使用穩定
- [ ] 無記憶體洩漏
- [ ] 電池消耗合理

### **代碼質量**
- [ ] Debug 輸出清晰
- [ ] 無編譯警告
- [ ] 無崩潰或錯誤
- [ ] 代碼註解完整

---

## 🎉 測試通過標準

**所有測試項目通過 ≥ 90%**

### **核心功能（必須 100%）**
- [x] 動態 alpha 正確計算
- [x] 標點權重正確設定
- [x] 靜音檢測正常運作
- [x] 標點停頓正確觸發

### **用戶體驗（建議 95%）**
- [ ] 字幕同步精準
- [ ] 停頓自然流暢
- [ ] 無明顯問題

### **性能表現（建議 90%）**
- [ ] CPU 正常
- [ ] 記憶體穩定
- [ ] 無崩潰

---

## 📝 測試報告範本

```markdown
# 測試日期：2025-XX-XX
# 測試人員：XXX
# 裝置型號：iPhone XX / iPad XX

## 測試結果

### 快速短句
- alpha 值：✅ 0.15
- 同步精度：✅ < 0.1s
- 驚嘆號停頓：✅ 快速

### 中速長句
- alpha 值：✅ 0.25
- 標點停頓：✅ 自然
- 平滑度：✅ 無跳躍

### 慢速長句
- alpha 值：✅ 0.35
- 靜音檢測：✅ 正確
- 句號停頓：✅ 明顯

### 性能表現
- CPU：✅ < 5%
- 記憶體：✅ 穩定
- 電池：✅ 正常

## 總結
✅ 所有測試通過
⚠️ 發現問題：（無）
💡 改進建議：（無）
```

---

**🚀 開始測試吧！祝一切順利！**
