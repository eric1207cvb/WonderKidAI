# 🧪 中文字幕同步測試清單

## 快速測試步驟

### 1️⃣ **測試卡拉 OK 效果（最重要）**

#### 測試步驟：
1. 啟動 App
2. 切換到中文模式
3. 問：「什麼是大象？」
4. **觀察字幕顯示：**

#### 預期結果：
```
播放前：
  大 象 是 一 種 很 大 的 動 物
  ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲
  （全部灰色）

播放中（第 3 個字）：
  大 象 是 一 種 很 大 的 動 物
  🔵 🔵 🔵⭐ ▲ ▲ ▲ ▲ ▲ ▲
  已唸 已唸 當前 未唸...
        放大
```

#### ❌ 如果出現問題：
- **問題 A：** 所有字都是灰色（字幕完全不動）
  - 原因：`currentWordIndex` 沒有更新
  - 檢查：Console 是否有 `[TTS][ZH]` 日誌
  
- **問題 B：** 正在唸的字不會放大
  - 原因：動畫條件錯誤
  - 檢查：`isCurrent` 變數是否正確

- **問題 C：** 字幕一次全部變藍色
  - 原因：`currentWordIndex` 直接跳到最後
  - 檢查：權重計算是否正確

---

### 2️⃣ **測試標點停頓差異（優化 2）**

#### 測試句子：
```
「大象很大。牠很聰明！你知道嗎？」
```

#### 預期行為：
| 標點 | 權重 | 停頓時間 | 觀察 |
|-----|------|---------|------|
| 。 | 0.9 | 最長 | 字幕在句號處停留較久 |
| ！ | 0.7 | 最短 | 字幕在驚嘆號處快速通過 |
| ？ | 0.8 | 中等 | 字幕在問號處停留中等時間 |

#### 測試方法：
1. 錄製螢幕
2. 慢動作播放
3. 對比三種標點的停留時間

---

### 3️⃣ **測試動態 Alpha（優化 4）**

#### 測試 A：快速語音
```
問：「大象」（只有兩個字）
預期：
  - Console 顯示：speedPerChar=0.05s, alpha=0.15
  - 字幕反應快速（幾乎沒有延遲）
```

#### 測試 B：慢速語音
```
問：「請詳細解釋大象的生活習性、食物來源和棲息環境」
預期：
  - Console 顯示：speedPerChar=0.22s, alpha=0.35
  - 字幕推進平滑（無跳動）
```

---

### 4️⃣ **測試標點減速（優化 5）**

#### 測試句子：
```
「從前從前，在一個遙遠的森林裡，住著一隻聰明的小狐狸。」
```

#### 觀察重點：
- [ ] 接近「，」時字幕減速
- [ ] 離開「，」後恢復速度
- [ ] 接近「。」時明顯減速
- [ ] 整體流暢無跳動

#### Debug 日誌：
```
[TTS][ZH] t=1.2/5.0 idx=8/25 alpha=0.25
[TTS][ZH] t=1.4/5.0 idx=9/25 alpha=0.25  ← 靠近「，」
[TTS][ZH] t=1.6/5.0 idx=9/25 alpha=0.25  ← 減速中（索引沒變）
[TTS][ZH] t=1.8/5.0 idx=10/25 alpha=0.25 ← 離開標點
```

---

### 5️⃣ **測試靜音補償（優化 6）**

#### 測試步驟：
1. 點擊「介紹」按鈕
2. **注意觀察前 0.5 秒**

#### 預期行為：
```
時間 0.0s - 0.25s：
  - 語音：靜音（還沒開始說話）
  - 字幕：停在第一個字（不動）⭐

時間 0.25s：
  - 語音：開始發音「嗨」
  - 字幕：開始推進（「嗨」變藍色）⭐

時間 2.8s（假設總長 3.0s）：
  - 語音：結束發音
  - 字幕：已經到達最後一個字⭐
```

#### Console 日誌：
```
[TTS][Silence] duration=3.45s, leading=0.25s, trailing=0.2s
[TTS][ZH] t=0.1/3.0 idx=0/45 alpha=0.25  ← 前 0.25s 索引保持 0
[TTS][ZH] t=0.3/3.0 idx=1/45 alpha=0.25  ← 開始推進
```

---

### 6️⃣ **測試 Easing 函數（優化 5）**

#### 測試方法：
1. 問任意問題
2. 觀察字幕在 **最後 20% 時間** 的行為

#### 預期曲線：
```
時間 80% → 字幕 84%
時間 85% → 字幕 87.2%
時間 90% → 字幕 91.2%
時間 95% → 字幕 96%
時間 100% → 字幕 100%

（後段加速，但平滑收斂）
```

#### 視覺檢查：
- [ ] 最後幾個字不會「卡住」
- [ ] 也不會「突然跳到最後」
- [ ] 平滑加速到結尾

---

## 🐛 常見問題排查

### 問題 1：字幕完全不動
**症狀：** 播放時所有字都是灰色

**排查步驟：**
1. 檢查 Console 是否有 `[TTS]` 開頭的日誌
   - ❌ 沒有 → `playAudio()` 沒被調用
   - ✅ 有 → 繼續下一步

2. 檢查日誌中的 `idx=` 數值
   - 如果一直是 `idx=0/45` → `currentWordIndex` 沒更新
   - 如果是 `idx=45/45` → 直接跳到最後了

3. 檢查 `characterData` 是否有內容
   ```swift
   print("characterData count: \(characterData.count)")
   ```

---

### 問題 2：字幕跳動嚴重
**症狀：** 字幕一次跳好幾個字

**排查步驟：**
1. 檢查 `dynamicAlpha` 值
   - 如果 > 0.5 → 太大了，減少到 0.35
   
2. 檢查 `maxStep` 值
   - 如果 > 0.05 → 太大了

3. 檢查權重計算
   ```
   [TTS][ZH] cumulative total is 0, fallback to uniform mapping
   → 權重計算失敗，使用備用方案
   ```

---

### 問題 3：開頭延遲還是很明顯
**症狀：** 語音開始說話但字幕不動

**排查步驟：**
1. 檢查 `leadingSilence` 值
   ```
   [TTS][Silence] duration=3.45s, leading=0.25s, trailing=0.2s
   ```
   - 如果 `leading` 太小（< 0.15s）→ 可能偵測錯誤
   - 如果 `leading` 太大（> 0.5s）→ 過度補償

2. 手動調整（如果自動檢測不準）：
   ```swift
   // 在 detectSilenceRegions() 中
   leadingSilence = 0.3  // 增加到 0.3 秒
   ```

---

### 問題 4：結尾拖延
**症狀：** 語音結束了但字幕還沒到最後

**排查步驟：**
1. 檢查 `trailingSilence` 值
2. 檢查是否使用了 Easing 函數（應該在 80% 後加速）

---

## 📊 性能測試

### 測試 1：CPU 使用率
```
工具：Xcode Instruments → Time Profiler
預期：字幕同步佔用 < 2% CPU
```

### 測試 2：記憶體使用
```
工具：Xcode Instruments → Allocations
預期：權重陣列佔用 < 50KB
```

### 測試 3：電池消耗
```
工具：Xcode Energy Log
預期：連續播放 10 分鐘，耗電 < 5%
```

---

## ✅ 最終檢查清單

### 功能檢查
- [ ] 卡拉 OK 效果正常（已唸/當前/未唸三種狀態）
- [ ] 放大動畫作用在「當前字」（不是前一個字）
- [ ] 不同標點停頓時間不同（句號 > 問號 > 驚嘆號）
- [ ] 快速語音反應快（alpha=0.15）
- [ ] 慢速語音平滑（alpha=0.35）
- [ ] 標點附近會減速
- [ ] 開頭沒有延遲（靜音補償）
- [ ] 結尾沒有拖延（靜音補償）
- [ ] 尾段平滑收斂（Easing 函數）

### Debug 日誌檢查
- [ ] 語速偵測日誌正確
- [ ] 靜音檢測日誌正確
- [ ] 播放進度日誌每秒更新
- [ ] 無錯誤或警告訊息

### UI 檢查
- [ ] 字幕顏色正確（藍色/灰色）
- [ ] 放大動畫流暢
- [ ] 滾動跟隨正常
- [ ] 橫向/直向模式都正常

### 性能檢查
- [ ] CPU 使用率正常（< 5%）
- [ ] 記憶體使用正常（< 100KB）
- [ ] 無明顯卡頓或延遲
- [ ] 電池消耗正常

---

## 🎉 測試完成！

如果所有項目都通過，恭喜你！字幕同步系統已經達到**業界領先水平**！

如果遇到問題，請參考上方的排查步驟，或查看詳細文件：
- `SUBTITLE_SYNC_IMPROVEMENTS.md` - 優化詳解
- `THREE_OPTIMIZATIONS_COMPLETE.md` - 整體優化總結

---

**Happy Testing! 🚀**
